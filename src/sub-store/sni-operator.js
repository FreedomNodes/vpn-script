"use strict";(()=>{const p=$substore;class v{constructor(t,s){this.expires=s;const n=p.read(t);n?this.resourceCache=JSON.parse(n):(this.resourceCache={},this._persist()),this._cleanup()}_cleanup(){let t=!1;const s=new Date().getTime();Object.keys(this.resourceCache).forEach(n=>{const r=this.resourceCache[n];(!r.time||s-r.time>this.expires)&&(delete this.resourceCache[n],p.delete(`#${n}`),t=!0)}),t&&this._persist()}revokeIds(t){let s=!1;for(const n of t)delete this.resourceCache[n],s=!0;s&&this._persist()}revokeAll(){this.resourceCache={},this._persist()}_persist(){p.write(JSON.stringify(this.resourceCache),key)}get(t){const s=this.resourceCache[t]&&this.resourceCache[t].time;return s&&new Date().getTime()-s<=this.expires?this.resourceCache[t].data:null}set(t,s){this.resourceCache[t]={time:new Date().getTime(),data:s},this._persist()}}const _=v;function l(e){return e&&e!=="null"&&e!=="undefined"}function w(e){const t=e.lastIndexOf("/");return new RegExp(e.slice(1,t),e.slice(t+1))}var C=(e,t,s)=>new Promise((n,r)=>{var u=i=>{try{a(s.next(i))}catch(o){r(o)}},c=i=>{try{a(s.throw(i))}catch(o){r(o)}},a=i=>i.done?n(i.value):Promise.resolve(i.value).then(u,c);a((s=s.apply(e,t)).next())});const g=$substore;function y(e){return!!/^[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,6}$/i.test(e)}function k(e){return!!/^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)(\/([1-9]|[1-2][0-9]|3[0-2])){0,1}$/.test(e)}function I(e,t){const s=e.split("."),n=t.split(".");if(s.length<3||n.length<3)return!1;for(let r=0;r<3;r++)if(s[r]!==n[r])return!1;return!0}function P(e){const t=e.split(".");return t[t.length-1]}function R(e){return C(this,null,function*(){return yield g.http.get(`https://dns.google/resolve?name=${e}`).then(s=>{const n=JSON.parse(s.body);if(n.Status===0){const r=n.Answer.find(u=>u.type===1);return r?r.data:""}return""})})}function d(e){let t;if(t=e.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/)){let s=0,n=1;for(let r=4;r>=1;r-=1)s+=n*parseInt(t[r]),n*=256;return s}else return-1}var $=(e,t,s)=>new Promise((n,r)=>{var u=i=>{try{a(s.next(i))}catch(o){r(o)}},c=i=>{try{a(s.throw(i))}catch(o){r(o)}},a=i=>i.done?n(i.value):Promise.resolve(i.value).then(u,c);a((s=s.apply(e,t)).next())});function S(){return $(this,null,function*(){const e=yield produceArtifact({type:"file",name:"sni_management"});return ProxyUtils.yaml.safeLoad(e)})}function E(e,t){e.type==="vmess"&&e.network==="ws"&&(e["ws-opts"]=e["ws-opts"]||{},e["ws-opts"].headers=e["ws-opts"].headers||{},e["ws-opts"].headers.Host=t),e.sni=t,isRealValue(e["skip-cert-verify"])||(e["skip-cert-verify"]=!0)}var h=(e,t,s)=>new Promise((n,r)=>{var u=i=>{try{a(s.next(i))}catch(o){r(o)}},c=i=>{try{a(s.throw(i))}catch(o){r(o)}},a=i=>i.done?n(i.value):Promise.resolve(i.value).then(u,c);a((s=s.apply(e,t)).next())});const O="#sub-store-cached-dns",b=7*24*60*60*1e3,m=new _(O,b);function x(e){return h(this,null,function*(){const{ignoreRule:t}=$arguments,s=yield S(),n=(c,a)=>w(c.regex).test(a.name),r=(c,a)=>c.ports.some(i=>i===a.port),u=(c,a)=>h(this,null,function*(){return(yield Promise.all(c.ips.map(o=>N(a.server,o)))).some(o=>o)});for(const c of e){let a="";for(const i in s){const o=s[i];if(l(o)){if(i==="default"){a=o.sni;continue}if((!t||!/true/i.test(t))&&(!l(o.skip)||!o.skip)){const f=[];if(l(o.regex)&&f.push(n),l(o.ports)&&f.push(r),l(o.ips)&&f.push(u),yield A(f,o,c)){a=o.sni;break}}}}E(c,a)}return e})}function A(e,t,s){return h(this,null,function*(){return(yield Promise.all(e.map(r=>r(t,s)))).every(r=>r)})}function N(e,t){return h(this,null,function*(){let s=e;if(y(e)){const n=m.get(e);if(n)s=n;else{const r=yield R(e);s=r,r&&m.set(e,r)}}return D(s,t)})}function D(e,t){if(!k(e))return!1;if(t.indexOf("/")<0)return!!(e===t||I(e,t)&&P(t)==="*");let s,n,r=d(e);if((s=t.match(/^(.*?)\/(\d{1,2})$/))&&(n=d(s[1]))>=0){const u=Math.pow(2,32-parseInt(s[2]));return r>=n&&r<=n+u-1}else return!1}window.operator=x;})();
