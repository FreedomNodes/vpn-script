(()=>{(()=>{"use strict";var M={};const d=$substore;class _{constructor(s,t){this.key=s,this.expires=t;const n=d.read(s);n?this.resourceCache=JSON.parse(n):(this.resourceCache={},this._persist()),this._cleanup()}_cleanup(){let s=!1;const t=new Date().getTime();Object.keys(this.resourceCache).forEach(n=>{const r=this.resourceCache[n];(!r.time||t-r.time>this.expires)&&(delete this.resourceCache[n],d.delete(`#${n}`),s=!0)}),s&&this._persist()}revokeIds(s){let t=!1;for(const n of s)delete this.resourceCache[n],t=!0;t&&this._persist()}revokeAll(){this.resourceCache={},this._persist()}_persist(){d.write(JSON.stringify(this.resourceCache),this.key)}get(s){const t=this.resourceCache[s]&&this.resourceCache[s].time;return t&&new Date().getTime()-t<=this.expires?this.resourceCache[s].data:null}set(s,t){this.resourceCache[s]={time:new Date().getTime(),data:t},this._persist()}}const w=_;function l(e){return e&&e!=="null"&&e!=="undefined"}function g(e){const s=e.lastIndexOf("/");return new RegExp(e.slice(1,s),e.slice(s+1))}var C=Math.pow,m=(e,s,t)=>new Promise((n,r)=>{var u=i=>{try{c(t.next(i))}catch(o){r(o)}},a=i=>{try{c(t.throw(i))}catch(o){r(o)}},c=i=>i.done?n(i.value):Promise.resolve(i.value).then(u,a);c((t=t.apply(e,s)).next())});const v=$substore;function I(e){return!!/^[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,6}$/i.test(e)}function k(e){return!!/^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)(\/([1-9]|[1-2][0-9]|3[0-2])){0,1}$/.test(e)}function P(e,s){const t=e.split("."),n=s.split(".");if(t.length<3||n.length<3)return!1;for(let r=0;r<3;r++)if(t[r]!==n[r])return!1;return!0}function $(e){const s=e.split(".");return s[s.length-1]}function R(e){return m(this,null,function*(){return yield v.http.get(`https://dns.google/resolve?name=${e}`).then(t=>{const n=JSON.parse(t.body);if(n.Status===0){const r=n.Answer.find(u=>u.type===1);return r?r.data:""}return""})})}function z(e){return m(this,null,function*(){return yield v.http.get(`http://ip-api.com/json/${e}?fields=country`).then(t=>JSON.parse(t.body).country||"")})}function F(e,s){let t,n;const r=f(e);if((t=s.match(/^(.*?)\/(\d{1,2})$/))&&(n=f(t[1]))>=0){const u=C(2,32-parseInt(t[2]));return r>=n&&r<=n+u-1}return!1}function f(e){let s;if(s=e.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/)){let t=0,n=1;for(let r=4;r>=1;r-=1)t+=n*parseInt(s[r]),n*=256;return t}return-1}var S=(e,s,t)=>new Promise((n,r)=>{var u=i=>{try{c(t.next(i))}catch(o){r(o)}},a=i=>{try{c(t.throw(i))}catch(o){r(o)}},c=i=>i.done?n(i.value):Promise.resolve(i.value).then(u,a);c((t=t.apply(e,s)).next())});function x(){return S(this,null,function*(){const e=yield produceArtifact({type:"file",name:"proxy_config"});return ProxyUtils.yaml.safeLoad(e)})}function E(e,s){e.type==="vmess"&&e.network==="ws"&&(e["ws-opts"]=e["ws-opts"]||{},e["ws-opts"].headers=e["ws-opts"].headers||{},e["ws-opts"].headers.Host=s),e.sni=s,l(e["skip-cert-verify"])||(e["skip-cert-verify"]=!0)}var O=Math.pow,p=(e,s,t)=>new Promise((n,r)=>{var u=i=>{try{c(t.next(i))}catch(o){r(o)}},a=i=>{try{c(t.throw(i))}catch(o){r(o)}},c=i=>i.done?n(i.value):Promise.resolve(i.value).then(u,a);c((t=t.apply(e,s)).next())});const N="#sub-store-cached-dns",b=7*24*60*60*1e3,y=new w(N,b);function A(e){return p(this,null,function*(){const{ignoreRule:s}=$arguments,t=yield x(),n=(a,c)=>g(a.regex).test(c.name),r=(a,c)=>a.ports.some(i=>i===c.port),u=(a,c)=>p(this,null,function*(){return(yield Promise.all(a.ips.map(o=>T(c.server,o)))).some(o=>o)});for(const a of e){let c="";for(const i in t){const o=t[i];if(l(o)){if(i==="default"){c=o.sni;continue}if((!s||!/true/i.test(s))&&(!l(o.skip)||!o.skip)){const h=[];if(l(o.regex)&&h.push(n),l(o.ports)&&h.push(r),l(o.ips)&&h.push(u),yield D(h,o,a)){c=o.sni;break}}}}E(a,c)}return e})}function D(e,s,t){return p(this,null,function*(){return(yield Promise.all(e.map(r=>r(s,t)))).every(r=>r)})}function T(e,s){return p(this,null,function*(){let t=e;if(I(e)){const n=y.get(e);if(n)t=n;else{const r=yield R(e);t=r,r&&y.set(e,r)}}return J(t,s)})}function J(e,s){if(!k(e))return!1;if(s.indexOf("/")<0)return!!(e===s||P(e,s)&&$(s)==="*");let t,n;const r=f(e);if((t=s.match(/^(.*?)\/(\d{1,2})$/))&&(n=f(t[1]))>=0){const u=O(2,32-parseInt(t[2]));return r>=n&&r<=n+u-1}return!1}window.operator=A})();})();
