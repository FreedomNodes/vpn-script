(()=>{(()=>{"use strict";var I={183:(c,u,l)=>{var d;typeof window!="undefined"?d=window:typeof l.g!="undefined"?d=l.g:typeof self!="undefined"?d=self:d={},c.exports=d}},m={};function h(c){var u=m[c];if(u!==void 0)return u.exports;var l=m[c]={exports:{}};return I[c](l,l.exports,h),l.exports}h.n=c=>{var u=c&&c.__esModule?()=>c.default:()=>c;return h.d(u,{a:u}),u},h.d=(c,u)=>{for(var l in u)h.o(u,l)&&!h.o(c,l)&&Object.defineProperty(c,l,{enumerable:!0,get:u[l]})},h.g=function(){if(typeof globalThis=="object")return globalThis;try{return this||new Function("return this")()}catch(c){if(typeof window=="object")return window}}(),h.o=(c,u)=>Object.prototype.hasOwnProperty.call(c,u);var L={};(()=>{var c=h(183),u=h.n(c);const l=$substore;class d{constructor(r,t){this.key=r,this.expires=t;const n=l.read(r);n?this.resourceCache=JSON.parse(n):(this.resourceCache={},this._persist()),this._cleanup()}_cleanup(){let r=!1;const t=new Date().getTime();Object.keys(this.resourceCache).forEach(n=>{const s=this.resourceCache[n];(!s.time||t-s.time>this.expires)&&(delete this.resourceCache[n],l.delete(`#${n}`),r=!0)}),r&&this._persist()}revokeIds(r){let t=!1;for(const n of r)delete this.resourceCache[n],t=!0;t&&this._persist()}revokeAll(){this.resourceCache={},this._persist()}_persist(){l.write(JSON.stringify(this.resourceCache),this.key)}get(r){const t=this.resourceCache[r]&&this.resourceCache[r].time;return t&&new Date().getTime()-t<=this.expires?this.resourceCache[r].data:null}set(r,t){this.resourceCache[r]={time:new Date().getTime(),data:t},this._persist()}}const P=d;function _(e){return e&&e!=="null"&&e!=="undefined"}function x(e){const r=e.lastIndexOf("/");return new RegExp(e.slice(1,r),e.slice(r+1))}var k=Math.pow,g=(e,r,t)=>new Promise((n,s)=>{var p=o=>{try{a(t.next(o))}catch(i){s(i)}},f=o=>{try{a(t.throw(o))}catch(i){s(i)}},a=o=>o.done?n(o.value):Promise.resolve(o.value).then(p,f);a((t=t.apply(e,r)).next())});const C=$substore;function O(e){return!!/^[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,6}$/i.test(e)}function $(e){return!!/^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)(\/([1-9]|[1-2][0-9]|3[0-2])){0,1}$/.test(e)}function R(e,r){const t=e.split("."),n=r.split(".");if(t.length<3||n.length<3)return!1;for(let s=0;s<3;s++)if(t[s]!==n[s])return!1;return!0}function S(e){const r=e.split(".");return r[r.length-1]}function E(e){return g(this,null,function*(){return yield C.http.get(`https://dns.google/resolve?name=${e}`).then(t=>{const n=JSON.parse(t.body);if(n.Status===0){const s=n.Answer.find(p=>p.type===1);return s?s.data:""}return""})})}function U(e){return g(this,null,function*(){return yield C.http.get(`http://ip-api.com/json/${e}?fields=country`).then(t=>JSON.parse(t.body).country||"")})}function V(e,r){let t,n;const s=v(e);if((t=r.match(/^(.*?)\/(\d{1,2})$/))&&(n=v(t[1]))>=0){const p=k(2,32-parseInt(t[2]));return s>=n&&s<=n+p-1}return!1}function v(e){let r;if(r=e.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/)){let t=0,n=1;for(let s=4;s>=1;s-=1)t+=n*parseInt(r[s]),n*=256;return t}return-1}var N=(e,r,t)=>new Promise((n,s)=>{var p=o=>{try{a(t.next(o))}catch(i){s(i)}},f=o=>{try{a(t.throw(o))}catch(i){s(i)}},a=o=>o.done?n(o.value):Promise.resolve(o.value).then(p,f);a((t=t.apply(e,r)).next())});function T(){return N(this,null,function*(){const e=yield produceArtifact({type:"file",name:"proxy_config"});return ProxyUtils.yaml.safeLoad(e)})}function A(e,r){e.type==="vmess"&&e.network==="ws"&&(e["ws-opts"]=e["ws-opts"]||{},e["ws-opts"].headers=e["ws-opts"].headers||{},e["ws-opts"].headers.Host=r),e.sni=r,_(e["skip-cert-verify"])||(e["skip-cert-verify"]=!0)}var D=Math.pow,w=(e,r,t)=>new Promise((n,s)=>{var p=o=>{try{a(t.next(o))}catch(i){s(i)}},f=o=>{try{a(t.throw(o))}catch(i){s(i)}},a=o=>o.done?n(o.value):Promise.resolve(o.value).then(p,f);a((t=t.apply(e,r)).next())});const M="#sub-store-cached-dns",j=7*24*60*60*1e3,b=new P(M,j);function F(e){return w(this,null,function*(){const{ignoreRule:r}=$arguments,t=yield T(),n=(f,a)=>x(f.regex).test(a.name),s=(f,a)=>f.ports.some(o=>o===a.port),p=(f,a)=>w(this,null,function*(){return(yield Promise.all(f.ips.map(i=>z(a.server,i)))).some(i=>i)});for(const f of e){let a="";for(const o in t){const i=t[o];if(_(i)){if(o==="default"){a=i.sni;continue}if((!r||!/true/i.test(r))&&(!_(i.skip)||!i.skip)){const y=[];if(_(i.regex)&&y.push(n),_(i.ports)&&y.push(s),_(i.ips)&&y.push(p),yield J(y,i,f)){a=i.sni;break}}}}A(f,a)}return e})}function J(e,r,t){return w(this,null,function*(){return(yield Promise.all(e.map(s=>s(r,t)))).every(s=>s)})}function z(e,r){return w(this,null,function*(){let t=e;if(O(e)){const n=b.get(e);if(n)t=n;else{const s=yield E(e);t=s,s&&b.set(e,s)}}return H(t,r)})}function H(e,r){if(!$(e))return!1;if(r.indexOf("/")<0)return!!(e===r||R(e,r)&&S(r)==="*");let t,n;const s=v(e);if((t=r.match(/^(.*?)\/(\d{1,2})$/))&&(n=v(t[1]))>=0){const p=D(2,32-parseInt(t[2]));return s>=n&&s<=n+p-1}return!1}u().operator=F})()})();})();
