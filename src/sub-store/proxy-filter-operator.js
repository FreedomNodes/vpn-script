(()=>{(()=>{"use strict";var M={};const f=$substore;class v{constructor(t,e){this.expires=e;const n=f.read(t);n?this.resourceCache=JSON.parse(n):(this.resourceCache={},this._persist()),this._cleanup()}_cleanup(){let t=!1;const e=new Date().getTime();Object.keys(this.resourceCache).forEach(n=>{const s=this.resourceCache[n];(!s.time||e-s.time>this.expires)&&(delete this.resourceCache[n],f.delete(`#${n}`),t=!0)}),t&&this._persist()}revokeIds(t){let e=!1;for(const n of t)delete this.resourceCache[n],e=!0;e&&this._persist()}revokeAll(){this.resourceCache={},this._persist()}_persist(){f.write(JSON.stringify(this.resourceCache),key)}get(t){const e=this.resourceCache[t]&&this.resourceCache[t].time;return e&&new Date().getTime()-e<=this.expires?this.resourceCache[t].data:null}set(t,e){this.resourceCache[t]={time:new Date().getTime(),data:e},this._persist()}}const g=v;function p(r){return r&&r!=="null"&&r!=="undefined"}function C(r){const t=r.lastIndexOf("/");return new RegExp(r.slice(1,t),r.slice(t+1))}var w=(r,t,e)=>new Promise((n,s)=>{var c=i=>{try{a(e.next(i))}catch(o){s(o)}},l=i=>{try{a(e.throw(i))}catch(o){s(o)}},a=i=>i.done?n(i.value):Promise.resolve(i.value).then(c,l);a((e=e.apply(r,t)).next())});const x=$substore;function I(r){return!!/^[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,6}$/i.test(r)}function P(r){return!!/^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]?|0)(\/([1-9]|[1-2][0-9]|3[0-2])){0,1}$/.test(r)}function $(r,t){const e=r.split("."),n=t.split(".");if(e.length<3||n.length<3)return!1;for(let s=0;s<3;s++)if(e[s]!==n[s])return!1;return!0}function E(r){const t=r.split(".");return t[t.length-1]}function R(r){return w(this,null,function*(){return yield x.http.get(`https://dns.google/resolve?name=${r}`).then(e=>{const n=JSON.parse(e.body);if(n.Status===0){const s=n.Answer.find(c=>c.type===1);return s?s.data:""}return""})})}function z(r,t){let e,n,s=m(r);if((e=t.match(/^(.*?)\/(\d{1,2})$/))&&(n=m(e[1]))>=0){const c=Math.pow(2,32-parseInt(e[2]));return s>=n&&s<=n+c-1}else return!1}function m(r){let t;if(t=r.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/)){let e=0,n=1;for(let s=4;s>=1;s-=1)e+=n*parseInt(t[s]),n*=256;return e}else return-1}var S=(r,t,e)=>new Promise((n,s)=>{var c=i=>{try{a(e.next(i))}catch(o){s(o)}},l=i=>{try{a(e.throw(i))}catch(o){s(o)}},a=i=>i.done?n(i.value):Promise.resolve(i.value).then(c,l);a((e=e.apply(r,t)).next())});function O(){return S(this,null,function*(){const r=yield produceArtifact({type:"file",name:"sni_management"});return ProxyUtils.yaml.safeLoad(r)})}var u=(r,t,e)=>new Promise((n,s)=>{var c=i=>{try{a(e.next(i))}catch(o){s(o)}},l=i=>{try{a(e.throw(i))}catch(o){s(o)}},a=i=>i.done?n(i.value):Promise.resolve(i.value).then(c,l);a((e=e.apply(r,t)).next())});const k="#sub-store-cached-dns",A=7*24*60*60*1e3,_=new g(k,A);function D(r){return u(this,null,function*(){const{type:t}=$arguments,e=yield O(),n=(i,o)=>C(i.regex).test(o.name),s=(i,o)=>i.ports.some(h=>h===o.port),c=(i,o)=>u(this,null,function*(){return(yield Promise.all(i.ips.map(d=>T(o.server,d)))).some(d=>d)}),l=e[t],a=[];for(const i of r){const o=[];p(l.regex)&&o.push(n),p(l.ports)&&o.push(s),p(l.ips)&&o.push(c),(yield N(o,l,i))&&a.push(i)}return a})}function N(r,t,e){return u(this,null,function*(){return(yield Promise.all(r.map(s=>s(t,e)))).every(s=>s)})}function T(r,t){return u(this,null,function*(){let e=r;if(I(r)){const n=_.get(r);if(n)e=n;else{const s=yield R(r);e=s,s&&_.set(r,s)}}return b(e,t)})}function b(r,t){if(!P(r))return!1;if(t.indexOf("/")<0)return!!(r===t||$(r,t)&&E(t)==="*");let e,n,s=y(r);if((e=t.match(/^(.*?)\/(\d{1,2})$/))&&(n=y(e[1]))>=0){const c=Math.pow(2,32-parseInt(e[2]));return s>=n&&s<=n+c-1}else return!1}function y(r){let t;if(t=r.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/)){let e=0,n=1;for(let s=4;s>=1;s-=1)e+=n*parseInt(t[s]),n*=256;return e}else return-1}window.operator=D})();})();
